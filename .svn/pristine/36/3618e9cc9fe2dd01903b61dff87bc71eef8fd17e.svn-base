<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>Perfil</title>
<link rel="stylesheet" href="../css/pagga.css">
<link rel='stylesheet' href='../css/bootstrap.min.css'>
<link rel='stylesheet' href='../css/style.min.css'>
</head>
<body>
	<form id="formPerfil" class='container'>

		<h1>Perfil de acesso</h1>

		<div id='message' class='alert' style="display: none"></div>

		<div class='form-group'>
			<label for='codigo'>CÃ³digo</label> <input class='form-control'
				id='codigo' name='codigo' readonly />
		</div>
		<div class='form-group'>
			<label for='descricao'>Descricao</label>
			<textarea id='descricao' class='form-control'></textarea>
		</div>

		<div id="divRotinasNoPerfil" class='form-group'></div>

		<div class="row">
			<div class="col-sm-1">
				<div class='float-right'>
					<button id='btnRotina' data-toggle="modal" type="button"
						data-target="#rotinaModal" class='btn btn-link'>Rotinas</button>
				</div>
			</div>

			<div class="col-sm">
				<div class='float-right'>
					<button id='btnSalva' class='btn btn-primary'>Salvar</button>
					<button id='btnExclui' type="button" class='btn btn-danger'
						data-toggle="modal" data-target="#excluirPerfilModal">Excluir</button>
					<button id='btnNovo' class='btn btn-primary'>Novo</button>
					<button id='btnVolta' class='btn btn-primary'>Voltar</button>
				</div>
			</div>
		</div>
	</form>

	<div class="modal fade" id="excluirPerfilModal" tabindex="-1"
		role="dialog" aria-labelledby="excluirPerfilModalLabel"
		aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="excluirPerfilModalLabel">Excluir
						Perfil</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Deseja realmente excluir este Perfil?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">Ignorar</button>
					<button type="button" id="btnConfirmar" class="btn btn-danger"
						data-dismiss="modal">Confirmar</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="rotinaModal" tabindex="-1" role="dialog"
		aria-labelledby="rotinaModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h6 class="modal-title" id="rotinaModalLabel">Rotinas</h6>
				</div>

				<div class="modal-body" id="divJstree"></div>

				<div class="modal-footer">
					<button type="button" id="btnRotinasPerfil" class="btn btn-danger"
						data-dismiss="modal">Confirmar</button>
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">Ignorar</button>
				</div>
			</div>
		</div>
	</div>

	<script src='../js/jquery.js'></script>
	<script src='../js/pagga.js'></script>
	<script type="text/javascript" src="../js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../js/jstree.min.js"></script>

	<script type='text/javascript'>
		$(document).ready(function() {
						
			var urlAnterior =  document.referrer;
			var url = new URL(window.location.href);
			let codigo = url.searchParams.get("codigo");
			history.replaceState(null, '', '../html/perfil-novo.html');
			
			if(codigo != '') {
				Pagga.perfil.busca.id(codigo).done(function(jqXHR){
					let perfil = JSON.parse(jqXHR).perfil;
					
					$("#descricao").val(perfil.descricao);
					$("#codigo").val(perfil.id);
					atualizaBotoes();
					
					perfil.perfilRotinaAtributo.forEach(function(rotina){
						let p = $("<p>");
						
						p.text(rotina.nomeRotina);
						
						$("#divRotinasNoPerfil").append(p);
						
					});
					
				});
			}
			
			$('#descricao').focus();
				atualizaBotoes();

			
			$("#btnRotina").click(function(event){
				event.preventDefault()
				rotinaTree();
			});
			
			
			$('#btnSalva').click(function(e) {
				e.preventDefault();
				
				$('#message').removeClass();
				$('#message').addClass('hide');
				let codigo = $('#codigo').val();
				let descricao = $('#descricao').val();

				
				Pagga.perfil.salva(codigo, descricao).done(function(jqXHR) {
					let perfil = jqXHR.perfil;
					$("#codigo").val(perfil.id);
					atualizaBotoes();
					exibeMensagem(perfil.msg, true);
				}).fail(function(jqXHR, textStatus, errorThrown) {
					var error = JSON.parse(jqXHR.responseText);
					exibeMensagem(error.message);
				});

			});

			$('#btnConfirmar').click(function(e) {
				e.preventDefault();

				let codigo = $('#codigo').val();
				
				Pagga.perfil.exclui(codigo).done(function(jqXHR) {
					$('#codigo').val('');
					$('#descricao').val('');
					exibeMensagem(jqXHR.msg);
					atualizaBotoes();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					var error = JSON.parse(jqXHR.responseText);
					exibeMensagem(error.message);
				});
			});
			
			$('#btnNovo').click(function(e){
				e.preventDefault();
				
				$('#codigo').val('');
				$('#descricao').val('');
				$('#message').hide();
				atualizaBotoes();
			})
			
			$('#btnVolta').click(function(e) {
				e.preventDefault();
				
				$(location).attr('href',urlAnterior);
			})
			
			function atualizaBotoes(){
				if($('#codigo').val() == '') {
					$('#btnExclui').hide();
					$('#btnNovo').hide();
				} else {
					$('#btnExclui').show();
					$('#btnNovo').show();
				}
			}
			
			function exibeMensagem(msg, sucesso){
				if(sucesso) {
					mostraDialogo('#message', 3000);
					$('#message').text(msg);
					$('#message').removeClass('hide');
					$('#message').addClass('alert');
					$('#message').addClass('alert-success');
					$('#message').addClass('alert-dismissible');
				} else {
					mostraDialogo('#message', 3000);
					$('#message').text(msg);
					$('#message').removeClass('hide');
					$('#message').addClass('alert');
					$('#message').addClass('alert-danger');
					$('#message').addClass('alert-dismissible');
				}
			}
			
			
			function rotinaTree() { 
				Pagga.perfil.lista.rotina().done(function(jqXHR) {
					
					let rotinas = jqXHR.rotinas;
					
					const bjt_rotina=[];
					
					for (let i = 0; i < rotinas.length; i++) {
						const t = rotinas[i];
						let bjt_children = [];
						
						t.atributoList.forEach((value) => {
							
							bjt_children.push({
								"text" : value.descricao,
								"id" : value.id
							});
						});
						
						bjt_rotina.push({
							"text" : t.descricao,
							"children" : bjt_children
						});
					}
					
					$('#divJstree').jstree({
						'core' : {
							'data' : bjt_rotina
						},
					    "checkbox" : {
					        "keep_selected_style": false
					      },
					      "plugins" : [ "checkbox" ]
				    });
					
				});	
			}
			
		});
		
		function mostraDialogo(mensagem, tempo){
			
		    $('#message').stop().fadeTo(1, 1).removeClass('hidden');
		    
		    setTimeout(function() {
		        $('#message').fadeTo(300, 0).slideUp(300, function(){
		        	$('#message').text('').addClass('hidden');
		        });
		    }, tempo);
		}
		
	</script>
</body>
</html>