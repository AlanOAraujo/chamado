<!DOCTYPE html>

<html>
	<head>
		<meta charset='UTF-8'>
		<title>Chamado</title>
		<link rel="stylesheet" href="../css/pagga.css?version=12">
		<link rel='stylesheet' href='../css/bootstrap.min.css'>
	</head>
	<body>
		
		<form id="formChamados">
		
			<section>			
				<div class="container">
					<div class="row">
					
						<div class="col-sm-6">
						
							<h1>Indicadores</h1>
						
						</div>
					
						<div class="col-sm">
							<div id="div-search-chm" class="input-group mb-3 input-search-chm">
								<select class="custom-select" id="selectFiltro">
									<option selected>Escolher...</option>
									<option value="id">Código</option>
									<option value="titulo">Título</option>
									<option value="descricao">Descrição</option>
									<option value="dataAbertura">Abertura</option>
									<option value="dataFechamento">Fechamento</option>
									<option value="dataPrevisao">Previsão</option>
									<option value="tipo">Tipo</option>
									<option value="nomeUsuario">Usuário</option>
									<option value="nomeUsuarioFechou">Usu/Fch</option>
								</select>
								
								<input id="input-search-ticket" type="text" class="form-control" aria-describedby="btn-ticket-search">
								
								<input id="input-date" type="date" class="form-control" style="display: none" aria-describedby="btn-ticket-search">
								
								<select class="custom-select form-control" id="selectTipo" style="display: none">
								  <option value="">Escolher...</option>
								  <option value="INCIDENTE">Incidente</option>
								  <option value="SOLICITACAO">Solicitação</option>
								  <option value="RELATORIO">Relatório</option>
								  <option value="DUVIDA">Dúvida</option>
								</select>
								
								<div class="input-group-append">
									<button class="btn btn-outline-secondary" type="button" id="btn-ticket-search">Ticket</button>
								</div>
							</div>
							
						</div>
					</div>
				</div>	
			</section>
			
			<section class="chm-tabelas">
			
				<div class="container">
					<div class="row">
						<div id="div-chmtb-aberto" class="table-responsive col-sm">
							<label for="chmtb-aberto">Resumo de Tickets abertos</label>
							
							<table id="chmtb-aberto" class="table table-striped table-sm table-bordered text-center">
								
								<thead>
									<tr>
										<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Código</th>
										<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Usuário</th>
										<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Tipo</th>
										<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Título</th>
										<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Data</th>
										<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Status</th>
									</tr>
								</thead>
								
								<tbody>
						
								</tbody>
							
							</table>
						
						</div>
						
						<div id="div-chmtb-andamento" class="table-responsive col-sm">
							<label for="chmtb-andamento">Resumo de Tickets em andamento</label>
							
							<table id="chmtb-andamento" class="table table-striped table-sm table-bordered text-center">
								
								<thead>
									<tr>
										<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Código</th>
										<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Usuário</th>
										<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Tipo</th>
										<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Previsão</th>
										<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Status</th>
									</tr>
								</thead>
								
								<tbody>
		
								</tbody>
							
							</table>
				
						</div>
						
					</div>
				</div>
				
				
				<div class="container">
					<div class="row">
						
						<div id="div-chmtb-historico" class="table-responsive col-sm">
							<label for="chmtb-historico">Histórico de tickets</label>
							
							<table id="chmtb-historico" class="table table-striped table-sm table-bordered text-center">
								
								<thead>
									<tr>
										<th class="chmtb-historico-th" aria-controls="chmtb-historico">Cód.Ticket</th>
										<th class="chmtb-historico-th" aria-controls="chmtb-historico">Usuário</th>
										<th class="chmtb-historico-th" aria-controls="chmtb-historico">Título</th>
										<th class="chmtb-historico-th" aria-controls="chmtb-historico">Data</th>
										<th class="chmtb-historico-th" aria-controls="chmtb-historico">Status</th>
									</tr>
								</thead>
								
								<tbody>
		
								</tbody>
							
							</table>
				
						</div>
					
						<div id="div-chmtb-finalizado" class="table-responsive col-sm">
							<label for="chmtb-finalizado">Resumo de Tickets finalizados</label>
							
							<table id="chmtb-finalizado" class="table table-striped table-sm table-bordered text-center">
								
								<thead>
									<tr>
										<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Código</th>
										<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Tipo</th>
										<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Fechado Por</th>
										<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Data finalizado</th>
										<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Status</th>
									</tr>
								</thead>
								
								<tbody>
		
								</tbody>
							
							</table>
				
						</div>
						
					</div>
				</div>
			</section>
		
		</form>
		
		<script type="text/javascript" src="../js/jquery.js"></script>
		<script type="text/javascript" src="../js/pagga.js"></script>
		<script type="text/javascript" src="../js/bootstrap.min.js"></script>
		
		<script type="text/javascript">
			$(document).ready(function() {
				$('#chmtb-historico').change(tabelaHistorico());
				$('#chmtb-aberto').change(tabelaAberto());
				$('#chmtb-andamento').change(tabelaAtendimento());
				$('#chmtb-finalizado').change(tabelaFinalizado());
				
				$('#selectFiltro').on('change',function(){
					if($(this).val() == 'tipo'){
						$('#input-search-ticket').val("").hide();
						$('#input-date').val("").hide();
						$('#selectTipo').val("").show();
					}else if($(this).val() == 'dataAbertura' || $(this).val() == 'dataFechamento' || $(this).val() == 'dataPrevisao'){
						$('#input-search-ticket').val("").hide();
						$('#selectTipo').val("").hide();
						$('#input-date').val("").show();
					}else{
						$('#input-search-ticket').val("").show();
						$('#selectTipo').val("").hide();
						$('#input-date').val("").hide();
					}
				})
				
			});
			
			function tabelaAberto(){
				
				let status = 'ABERTO';	
				
				Pagga.chamado.status(status).done(function(jqXHR) {
					
					var chamados =  JSON.parse(jqXHR).chamados;
					
					chamados.sort(function(a, b) {
						return b.id - a.id;
					})
					
					chamados.forEach(function(chamado) {
						
						var linhas = novaLinhaAberto(chamado.id, chamado.usuario.nome, chamado.tipo, chamado.titulo, chamado.data, chamado.status);
						$("#chmtb-aberto tbody").append(linhas);
					});
					
					inicializaIdHistorico();
				})
			}
			
			function tabelaAtendimento(){
				
				let status = 'EM_ATENDIMENTO';	
				
				Pagga.chamado.status(status).done(function(jqXHR) {
					
					var chamados =  JSON.parse(jqXHR).chamados;
					
					chamados.sort(function(a, b) {
						return b.id - a.id;
					})
					
					chamados.forEach(function(chamado) {
						
						var linhas = novaLinhaAtendimento(chamado.id, chamado.usuario.nome, chamado.tipo, chamado.dataPrevisao, chamado.status);
						$("#chmtb-andamento tbody").append(linhas);
					});
					inicializaIdHistorico();
				})
			}			
			
			function tabelaFinalizado(){
				
				let statusFechado = 'FECHADO';	
				let statusCancelado = 'CANCELADO';
				
				var chamados
				
				Pagga.chamado.status(statusFechado).done(function(jqXHR) {
					
					chamados =  JSON.parse(jqXHR).chamados;
					
						chamados.sort(function(a, b) {
							return b.id - a.id;
						})
					
					chamados.forEach(function(chamado) {
						
						var linhas = novaLinhaFechamento(chamado.id, chamado.tipo, chamado.usuarioFechamento.nome, chamado.dataFechamento, chamado.status);
						$("#chmtb-finalizado tbody").append(linhas);
					});
					inicializaIdHistorico();
				})
				
				Pagga.chamado.status(statusCancelado).done(function(jqXHR) {
					
					var chamados =  JSON.parse(jqXHR).chamados;
					
					chamados.sort(function(a, b) {
						return b.id - a.id;
					})
					
					chamados.forEach(function(chamado) {
						
						var linhas = novaLinhaFechamento(chamado.id, chamado.tipo, chamado.usuarioFechamento.nome, chamado.dataFechamento, chamado.status);
						$("#chmtb-finalizado tbody").append(linhas);
					});
					inicializaIdHistorico();
				})
			}
			
			function tabelaHistorico(){
						
				Pagga.historico.lista().done(function(jqXHR) {
					
					var historicos =  jqXHR.historicos;
					
					historicos.sort(function(a, b) {
						return b.id - a.id;
					})
					
					historicos.forEach(function(historico) {
						
						var linhas = novaLinhaHistorico(historico.chamadoid, historico.usuario, historico.titulo, historico.datacomentario, historico.status);
						$("#chmtb-historico tbody").append(linhas);
					});
					inicializaIdHistorico();
				})
			}	
				
			function novaLinha(codigo, titulo, data, status, tipo) {
				
				var linha = $("<tr>");
				var colunaCodigo = $("<td>");
				var colunaTitulo = $("<td>").text(titulo);
				var colunaData = $("<td>").text(data);
				var colunaStatus = $("<td>").text(status);
				var colunaTipo = $("<td>").text(tipo);
				
				var link = $("<a>").text(codigo).addClass("idChamado card-link btn-historico");
				
				colunaCodigo.append(link);
	
				linha.append(colunaCodigo);
				linha.append(colunaTitulo);
				linha.append(colunaData);
				linha.append(colunaStatus);
				linha.append(colunaTipo);
	
				return linha;
			}
			
			$('#btn-ticket-search').on('click', function(){
				pesquisarTickets();
			});
			
			function pesquisarTickets(){
				
				let selectPesquisa = $('#selectFiltro option:selected').val();
				let inputPesquisa = $('#input-search-ticket').val();
				let inputData = new Date($('#input-date').val());
				let selectTipo = $('#selectTipo option:selected').val();
				
				let filtro = {}
				
				if(selectPesquisa == 'id'){
					filtro.id = inputPesquisa;
				}
				
				if(selectPesquisa == 'titulo'){
					filtro.titulo = inputPesquisa;
				}
				
				if(selectPesquisa == 'descricao'){
					filtro.descricao = inputPesquisa;
				}
				
				if(selectPesquisa == 'dataAbertura'){
					let dataFormatada = (inputData.getDate() + 1 ) + '/' + (inputData.getMonth() + 1) + '/' + inputData.getFullYear();
					filtro._dataAbertura = dataFormatada;
				}
				
				if(selectPesquisa == 'dataFechamento'){
					let dataFormatada = (inputData.getDate() + 1 ) + '/' + (inputData.getMonth() + 1) + '/' + inputData.getFullYear();
					filtro._dataFechamento = dataFormatada;
				}
				
				if(selectPesquisa == 'dataPrevisao'){
					let dataFormatada = (inputData.getDate() + 1 ) + '/' + (inputData.getMonth() + 1) + '/' + inputData.getFullYear();
					filtro.dataPrevisao = dataFormatada;
				}
				
				if(selectPesquisa == 'status'){
					filtro.status = inputPesquisa;
				}
				
				if(selectPesquisa == 'tipo'){
					filtro.tipoDescricao = selectTipo;
				}
				
				if(selectPesquisa == 'nomeUsuario'){
					filtro.nomeUsuario = inputPesquisa;
				}
				
				if(selectPesquisa == 'nomeUsuarioFechou'){
					filtro.nomeUsuarioFechou = inputPesquisa;
				}
				
				if(inputPesquisa == "" && selectTipo == "" && inputData == ""){
					$('table tbody tr').remove();
					$('#chmtb-historico').change(tabelaHistorico());
					$('#chmtb-aberto').change(tabelaAberto());
					$('#chmtb-andamento').change(tabelaAtendimento());
					$('#chmtb-finalizado').change(tabelaFinalizado());
				}else {	
					
					Pagga.chamado.busca(filtro).done(function(jqXHR){
						
						$('table tbody tr').remove();
						
						let json = jqXHR;
						
						let chamados = json.chamado;
						
						json.chamados.forEach(function(chamado){
							
							if(chamado.status == 'Aberto'){
								var linhas =  novaLinhaAberto(chamado.id, chamado.nomeUsuario, chamado.tipo, chamado.titulo, chamado.data, chamado.status);
								$("#chmtb-aberto").append(linhas);
								inicializaIdHistorico();
							}
							
							if(chamado.status == 'Em atendimento'){
								var linhas = novaLinhaAtendimento(chamado.id, chamado.nomeUsuario, chamado.tipo, chamado.dataPrevisao, chamado.status);
								$("#chmtb-andamento").append(linhas);
								inicializaIdHistorico();
							}
							
							if(chamado.status == 'Fechado'){
								var linhas = novaLinhaFechamento(chamado.id, chamado.tipo, chamado.nomeUsuarioFechou, chamado.dataFechamento, chamado.status);
								$("#chmtb-finalizado").append(linhas);
								inicializaIdHistorico();
							}
							
							if(chamado.status == 'Cancelado'){
								var linhas = novaLinhaFechamento(chamado.id, chamado.tipo, chamado.nomeUsuarioFechou, chamado.dataFechamento, chamado.status);
								$("#chmtb-finalizado").append(linhas);
								inicializaIdHistorico();
							}
						})
						
					}).fail(function(jqXHR, textStatus, errorThrown) {
						console.log(jqXHR);
						
					});
				}	
			}
			
			function inicializaIdHistorico() {
				$(".btn-historico").on("click", function(event){
					let id = this.parentElement.parentElement.getElementsByClassName('idChamado')[0].textContent;
					
					var url = "../html/historico.html?id="+id;
					$(location).attr('href',url);
				});
			}
			
			function novaLinhaHistorico(codigo, usuario, titulo, data, status) {
				
				var linha = $("<tr>");
				var colunaCodigo = $("<td>");
				var colunaUsuario = $("<td>").text(usuario);
				var colunaTitulo = $("<td>").text(titulo);
				var colunaData = $("<td>").text(data);
				var colunaStatus = $("<td>").text(status);

				var link = $("<a>").text(codigo).addClass("idChamado card-link btn-historico");
				
				colunaCodigo.append(link);
	
				linha.append(colunaCodigo);
				linha.append(colunaUsuario);
				linha.append(colunaTitulo);
				linha.append(colunaData);
				linha.append(colunaStatus);
	
				return linha;
			}
			
			function novaLinhaAberto(codigo, usuario, titulo, data, status, tipo) {
				
				var linha = $("<tr>");
				var colunaCodigo = $("<td>");
				var colunaUsuario = $("<td>").text(usuario);
				var colunaTitulo = $("<td>").text(titulo);
				var colunaData = $("<td>").text(data);
				var colunaStatus = $("<td>").text(status);
				var colunaTipo = $("<td>").text(tipo);
				
				var link = $("<a>").text(codigo).addClass("idChamado card-link btn-historico");
				
				colunaCodigo.append(link);
	
				linha.append(colunaCodigo);
				linha.append(colunaUsuario);
				linha.append(colunaTitulo);
				linha.append(colunaData);
				linha.append(colunaStatus);
				linha.append(colunaTipo);
	
				return linha;
			}
			
			function novaLinhaAndamento(codigo, usuario, data, status, tipo) {
				
				var linha = $("<tr>");
				var colunaCodigo = $("<td>");
				var colunaUsuario = $("<td>").text(usuario);
				var colunaData = $("<td>").text(data);
				var colunaStatus = $("<td>").text(status);
				var colunaTipo = $("<td>").text(tipo);
				
				var link = $("<a>").text(codigo).addClass("idChamado card-link btn-historico");
				
				colunaCodigo.append(link);
	
				linha.append(colunaCodigo);
				linha.append(colunaUsuario);
				linha.append(colunaData);
				linha.append(colunaStatus);
				linha.append(colunaTipo);
	
				return linha;
			}
			
		function novaLinhaAtendimento(codigo, usuario, data, status, tipo) {
				
				var linha = $("<tr>");
				var colunaCodigo = $("<td>");
				var colunaUsuario = $("<td>").text(usuario);
				var colunaData = $("<td>").text(data);
				var colunaStatus = $("<td>").text(status);
				var colunaTipo = $("<td>").text(tipo);
				
				var link = $("<a>").text(codigo).addClass("idChamado card-link btn-historico");
				
				colunaCodigo.append(link);
	
				linha.append(colunaCodigo);
				linha.append(colunaUsuario);
				linha.append(colunaData);
				linha.append(colunaStatus);
				linha.append(colunaTipo);
	
				return linha;
			}
		
		function novaLinhaFechamento(codigo, usuario, data, status, tipo) {
			
			var linha = $("<tr>");
			var colunaCodigo = $("<td>");
			var colunaUsuario = $("<td>").text(usuario);
			var colunaData = $("<td>").text(data);
			var colunaStatus = $("<td>").text(status);
			var colunaTipo = $("<td>").text(tipo);
			
			var link = $("<a>").text(codigo).addClass("idChamado card-link btn-historico");
			
			colunaCodigo.append(link);

			linha.append(colunaCodigo);
			linha.append(colunaUsuario);
			linha.append(colunaData);
			linha.append(colunaStatus);
			linha.append(colunaTipo);

			return linha;
		}
			
		</script>
	
	</body>
</html>