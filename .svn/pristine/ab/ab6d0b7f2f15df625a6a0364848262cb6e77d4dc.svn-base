<!DOCTYPE html>

<html lang="pt-br">
	<head>
		<meta charset="UTF-8">
		<title>Perfil</title>
		<link rel="stylesheet" href="../css/pagga.css?version=12">
		<link rel="stylesheet" href="../css/bootstrap.min.css">
	</head>
	<body>
		<main class="container">
	
			<h1>Perfil</h1>
			
			<div id='message' class='alert'></div>
		
			<div id="datatb-wrapper">
		
				<div class="form-group">
					<label for="datatb-search">Pesquisar:</label>
		
					<div class="input-group">
						<input id="datatb-search" type="search" class="form-control" aria-controls="datatb" >
						<button id="datatb-btn-search" class="btn btn-primary">Buscar</button>
					</div>
		
				</div>
				
				<div id="div-datatb" class="table-responsive">
		
					<table id="datatb"
						class="table table-striped table-sm table-bordered text-center">
						<thead>
							<tr>
								<th class="datatb-th" aria-controls="datatb">Código</th>
								<th class="datatb-th" aria-controls="datatb">Descrição</th>
								<th class="datatb-th" aria-controls="datatb">Editar</th>
							</tr>
						</thead>
						<tbody>
		
						</tbody>
					</table>
		
				</div>
		
			</div>
			<div class="float-right">
				<a href="perfil-novo.html" id="btn-novoperfil" class="btn btn-primary">Novo
					Perfil</a>
			</div>
	
		</main>
	
		<script type="text/javascript" src="../js/jquery.js"></script>
		<script type="text/javascript" src="../js/pagga.js"></script>
	
	
		<script type="text/javascript">
			$(document).ready(function() {
				listaPerfils();
			});
			
			function novaLinha(codigo, descricao) {
				var linha = $("<tr>");
				var colunaCodigo = $("<td>").text(codigo);
				var colunaDescricao = $("<td>").text(descricao);
				var colunaEditar = $("<td>");
	
				colunaDescricao.addClass("datatb-descricaoperfil");
			
				var link = $("<a>").text('Editar')
						.addClass("btn btn-light btn-editar btn-sm");
				
				colunaEditar.append(link);
				
				colunaDescricao.addClass("descricao");
				colunaCodigo.addClass("codigo");
				
				linha.append(colunaCodigo);
				linha.append(colunaDescricao);
				linha.append(colunaEditar);
	
				return linha;
			}

			$('#datatb-btn-search').on('click',function(){
				pesquisaTable();
			});
	
			function pesquisaTable() {
				
				let descricao = $('#datatb-search').val();
				
				if(descricao == ""){
					$('table tbody tr').remove();
					listaPerfils();
				}else {
					
					debugger;
					
					Pagga.perfil.busca(descricao).done(function(jqXHR){
						console.log(jqXHR);
						
						$('table tbody tr').remove();
						
						let json = $.parseJSON(jqXHR);
						
						let perfils = json.perfil;
						
						perfils.sort(function(a, b) {
							return a.id - b.id;
						})
						
						console.log(perfils);
						
						json.perfil.forEach(function(perfil){
							
							var linhas = novaLinha(perfil.id, perfil.descricao);
							$("tbody").append(linhas);
							
							console.log(linhas);
							
						})
						
						inicializaBotaoEditar();
						
					}).fail(function(jqXHR, textStatus, errorThrown) {
						console.log(jqXHR);
						var error = JSON.parse(jqXHR.responseText);
						mostraDialogo('#message', 3000)
						$('#message').removeClass();
						$('#message').text(error.message);
						$('#message').addClass('alert');
						$('#message').addClass('alert-danger');
						$('#message').addClass('alert-dismissible');
						
					});
				}	
			}
			
			function listaPerfils(){
				Pagga.perfil.lista().done(function(jqXHR) {
					
					let perfils = jqXHR.perfis;
	
					perfils.sort(function(a, b) {
						return a.id - b.id;
					})
	
					jqXHR.perfis.forEach(function(perfil) {
						var linhas = novaLinha(perfil.id, perfil.descricao);
						$("tbody").append(linhas);
					});
					
					inicializaBotaoEditar();
				}).fail(function(jqXHR, textStatus, errorThrown ){
					
					var linha = $("<tr>");
					var colunaCodigoVazio = $("<td>");
					var colunaMensagem = $("<td>").text('Não a Perfis registrados!');
					var colunaEditarVazio = $("<td>");
		
					linha.append(colunaCodigoVazio);
					linha.append(colunaMensagem);
					linha.append(colunaEditarVazio);
					
					$("tbody").append(linha);
				})
			}
						
			function inicializaBotaoEditar() {				
				$(".btn-editar").on("click", function(event){
					let desc = this.parentElement.parentElement.getElementsByClassName('descricao')[0].textContent;
					let cod = this.parentElement.parentElement.getElementsByClassName('codigo')[0].textContent;
					
					var url = "../html/perfil-novo.html?codigo="+cod;
					$(location).attr('href',url).attr("type", "hidden");
				});
			}
			
			function mostraDialogo(mensagem, tempo){
					
			    $('#message').stop().fadeTo(1, 1).removeClass('hidden');
			    
			    setTimeout(function() {
			        $('#message').fadeTo(300, 0).slideUp(300, function(){
			        	$('#message').text('').addClass('hidden');
			        });
			    }, tempo);

			}
			
		</script>
	
	</body>
</html>