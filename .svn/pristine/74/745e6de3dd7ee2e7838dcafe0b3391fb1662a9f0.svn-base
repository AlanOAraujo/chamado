<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="../css/pagga.css?version=12">
<link rel="stylesheet" href="../css/bootstrap.min.css">
<link rel="stylesheet" href="../css/all.css">
<title>Cadastro de Usuário</title>
</head>
<body>
	<form id="formUsuario" class="container">
		<h1>Cadastro de Usuário</h1>

		<div id='message' class='alert'></div>
	
		<div class="row">
			<div class="col-md-8">
				<div class="form-group">
					<label for="nome">Nome</label>
					<input id="nome" class="form-control"/>
					<label for="email" style="margin-top: 0.5em">E-mail</label>
					<input id="email" class="form-control"/>
				</div>
			</div>
			
			<div class="col-md">
				<div class="form-group">
					<label for="cpf">CPF</label>
					<input id="cpf" class="form-control"/>
					<div class="row" style="margin-top: 0.5em">
						<div class="col-md-9" >
							<label for="senha">Senha</label>
							<input type="password" id="senha" class="form-control"/>
						</div>
						<div id="divSituacao" class="col-md">
							<label for="situacao" style="width: 100%; text-align: center;">Situação</label>
							<div class="row">
								<input type="button" id="situacaoAtivo" class="btn btn-light" value="Ativar">
							</div>
							<div class="row">
								<input type="button" id="situacaoInativo" class="btn btn-light" value="Inativar">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md">
				<h3>Perfil de acesso</h3>
			</div>
		</div>
		<div class="row">
			<div class="col-md-3">
				<select id="perfis" multiple size="6" style="width: 15em">
				</select>
			</div>
			<div class="col-md-1">
				<div class="row">
					<button id='adicionarPerfil' class='btn btn-primary' style="margin: 1em"><i class="fas fa-angle-right"></i></button>
				</div>
				<div class="row">
					<button id='removerPerfil' class='btn btn-primary' style="margin: 1em"><i class="fas fa-angle-left"></i></button>
				</div>
			</div>
			<div class="col-md-3">
				<select id="perfisSelecionados" multiple size="6" style="width: 15em">
				</select>
			</div>
		</div>
		<a class="btn btn-primary" href="perfil-novo.html">Novo Perfil</a>
		<div class="row float-right">
			<button class="btn btn-primary" id="salvar">Salvar</button>
			<button id='btnNovo' class='btn btn-primary' style="margin-left: 0.5em">Novo</button>
			<a class="btn btn-primary" id="sair" style="margin-left: 0.5em" href="usuario.html">Sair</a>
		</div>
	</form>
	<script type="text/javascript" src="../js/jquery.js"></script>
	<script type="text/javascript" src="../js/pagga.js"></script>
	<script type="text/javascript" src="../js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../js/all.js"></script>
	
	<script type="text/javascript">
		$(document).ready(function(){
			
			listaPerfis();
			
			$("#btnNovo").hide();
			$("#divSituacao").hide();
			
			var url = new URL(window.location.href);
			var id = url.searchParams.get("id");
			history.replaceState(null, '', '../html/usuario-novo.html');
			
			var form = $("#formUsuario");
			
			if(id != null && id != '') {
			
				Pagga.usuario.busca(id).done(function(jqXHR) {
					
					$("#btnNovo").show();
					$("#divSituacao").show();
					
					var usuario = JSON.parse(jqXHR).usuario;
					
					console.log(usuario);
					
					$("#nome").val(usuario.nome);
					$("#cpf").val(usuario.cpf);
					$("#email").val(usuario.email);
					$("#senha").val(usuario.senha);
					
					if(usuario.situacao == true){
						$("#situacaoAtivo").hide();
						$("#situacaoInativo").show();
					} else {
						$("#situacaoAtivo").show();
						$("#situacaoInativo").hide();
					}
					
					usuario.usuarioPerfilList.forEach(function(perfil) {
						adicionaPerfil(perfil.descricao);
					});
					
					$("#situacaoAtivo").click(function(e) {
						e.preventDefault();
						
						let nome = $("#nome").val();
						let email = $("#email").val();
						let cpf = $("#cpf").val();
						
						Pagga.usuario.ativo(id, nome, email, cpf).done(function(jqXHR) {
							exibeMensagem(jqXHR.msg, true);
						}).fail(function(jqXHR) {
							console.log(jqXHR);
							var error = JSON.parse(jqXHR.responseText);
							exibeMensagem(error.message);
						});
					});
					
					$("#situacaoInativo").click(function(e) {
						e.preventDefault();
						
						let nome = $("#nome").val();
						let email = $("#email").val();
						let cpf = $("#cpf").val();
						
						Pagga.usuario.inativa(id, nome, email, cpf).done(function(jqXHR) {
							exibeMensagem(jqXHR.msg, true);
						}).fail(function(jqXHR) {
							console.log(jqXHR);
							var error = JSON.parse(jqXHR.responseText);
							exibeMensagem(error.message);
						});
					});
					
				});
				
			}
			
			$("#adicionarPerfil").click(function(e) {
				e.preventDefault();
				let perfis = $("#perfis").val();
				perfis.forEach(adicionaPerfil);
			});
			
			$("#removerPerfil").click(function(e) {
				e.preventDefault();
				let perfis = $("#perfisSelecionados").val();
				perfis.forEach(removePerfil);
			});
			
			$("#salvar").click(function(e) {
				$("#message").removeClass();
				$("#message").addClass("hide");
				e.preventDefault();
				let nome = $("#nome").val();
				let email = $("#email").val();
				let cpf = $("#cpf").val();
				let senha = $("#senha").val();
				let ativo = $("#situacao").val();
				let perfis = [];
				
				let options = $(document.getElementById("perfisSelecionados").getElementsByTagName("option"));
				
				for(var i = 0; i < options.length; i++) {
					perfis.push($(options[i]).attr("label"));
				}
				
				if(id != null && id != '') {
					Pagga.usuario.altera(id, nome, email, cpf, senha, ativo, perfis).done(function(jqXHR) {
						exibeMensagem(jqXHR.msg, true);
					}).fail(function(jqXHR) {
						console.log(jqXHR);
						var error = JSON.parse(jqXHR.responseText);
						exibeMensagem(error.message);
					});
				} else {
					Pagga.usuario.salva(nome, email, cpf, senha, ativo, perfis).done(function(jqXHR) {
						id = jqXHR.id;
						exibeMensagem(jqXHR.msg, true);
					}).fail(function(jqXHR) {
						var error = JSON.parse(jqXHR.responseText);
						exibeMensagem(error.message);
					});
				}
			});
			
			$("#btnNovo").click(function(e){
				e.preventDefault();
				id = '';
				
				$("#nome").val("");
				$("#cpf").val("");
				$("#email").val("");
				$("#senha").val("");
				$("#divSituacao").hide();
				
				let options = $(document.getElementById("perfisSelecionados").getElementsByTagName("option"));
				
				for(var i = 0; i < options.length; i++) {
					removePerfil($(options[i]).val());
				}
				
				$("#btnNovo").hide();
				
			});
					
			function listaPerfis() {
				Pagga.perfil.lista().done(function(jqXHR) {
					let perfis = jqXHR.perfis;
					
					perfis.forEach(function(perfil){
						var option = $("<option>");
						option.text(perfil.descricao);
						option.attr("label", perfil.id);
						option.attr("id", perfil.descricao);
						$("#perfis").append(option);
					})
				}).fail(function(jqXHR, textStatus, errorThrown) {
					var error = JSON.parse(jqXHR.responseText);
					exibeMensagem(error.message);
				});
			}
			
			function adicionaPerfil(descricao){
				$("#perfisSelecionados").append($("#"+descricao));
			}
			
			function removePerfil(descricao){
				$("#perfis").append($("#"+descricao));
			}
			
			function exibeMensagem(msg, sucesso){
				if(sucesso) {
					mostraDialogo('#message', 3000);
					$('#message').text(msg);
					$('#message').removeClass('hide');
					$('#message').addClass('alert');
					$('#message').addClass('alert-success');
					$('#message').addClass('alert-dismissible');
				} else {
					mostraDialogo('#message', 3000);
					$('#message').text(msg);
					$('#message').removeClass('hide');
					$('#message').addClass('alert');
					$('#message').addClass('alert-danger');
					$('#message').addClass('alert-dismissible');
				}
			}
		});
		
		function mostraDialogo(mensagem, tempo){
			
		    $('#message').stop().fadeTo(1, 1).removeClass('hidden');
		    
		    setTimeout(function() {
		        $('#message').fadeTo(300, 0).slideUp(300, function(){
		        	$('#message').text('').addClass('hidden');
		        });
		    }, tempo);
		}
	</script>
</body>
</html>