<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="../css/pagga.css?version=12">
<link rel="stylesheet" href="../css/bootstrap.min.css">
<title>Chamado</title>
</head>
<body>
	<main class="container">
	<h1>Chamado</h1>
	<div class="row">
		<div class="col-md-3 border-right">
			<div class="row">
				<div class="col-md">
					<label for="selectStatus">Status</label>
					<select id="selectStatus">
						<option value="Aberto">Aberto</option>
						<option value="Em atendimento">Em atendimento</option>
						<option value="Fechado">Fechado</option>
						<option value="Cancelado">Cancelado</option>
					</select>
				</div>
				<div class="col-md">
					<label for="selectPrioridade">Prioridade</label>
					<select id="selectPrioridade">
						<option>Alta</option>
						<option>Media</option>
						<option>Baixa</option>
					</select>
				</div>
			</div>
			<div>
				<div class="form-group">
					<label for="previsao">Previsão de solução</label>
					<input type="date" id="previsao">
				</div>
				<div class="form-group">
					<label for="nomeSolicitante">Solicitante</label>
					<input id="nomeSolicitante" disabled="disabled">
				</div>
				<div class="form-group">
					<label for="categoria">Categoria</label>
					<select id="categoria">
						<option>Dúvida</option>
						<option>Problema</option>
						<option>Solicitação de Serviços</option>
					</select>
				</div>
				<div class="form-group">
					<label for="tags" style="width: 100%">Tags</label>
					<input id="tags" disabled="disabled">
				</div>
			</div>
		</div>
		<div class="col-md" style="margin: 0.5em">
			<div class="row">
				<label for="acao">Ação pública</label>
				<textarea rows="6" id="acao" style="width: 100%"></textarea>
			</div>
			<div class="row">
				<div class="col-md">
					<input type="file" id="anexo">
				</div>
				<div class="col-md-5">
					<select id="opcaoStatus" style="margin-top: 0.5em; margin-right: 0.5em">
						<option>Manter status atual</option>
						<option value="Aberto">Aberto</option>
						<option value="Em atendimento">Em atendimento</option>
						<option value="Fechado">Fechado</option>
						<option value="Cancelado">Cancelado</option>
					</select>
					<button id="btnAdicionar" class="btn btn-primary" style="margin-top: 0.5em; margin-right: 0.5em">Adicionar ação</button>
				</div>
			</div>
			<div class="row" style="width: 100%">
				<label for="historicoDiv" style="width: 100%">Histórico</label>
				<div id="historicoDiv" class="border" style="width: 100%; height: 15em; background-color: #EEEEEE; overflow-y: scroll;">
					<div class="border-bottom" >
						<h5>José da Silva 14/01/2019</h5>
						<h6><strong>Um chamado qualquer</strong></h6>
						<p>Seirj dfs dfokg çdkfaç~dfkgçdfg çkd s~çkgçsdfkg lfdkgçdsfk gçdsfk gçdksfgçksdç~fkg çksdf  çlfdkg ioj bnt io5.</p>
					</div>
					<div class="border-bottom">
						<h5>José da Silva 14/01/2019</h5>
						<h6><strong>Um chamado qualquer</strong></h6>
						<p>Seirj dfs dfokg çdkfaç~dfkgçdfg çkd s~çkgçsdfkg lfdkgçdsfk gçdsfk gçdksfgçksdç~fkg çksdf  çlfdkg ioj bnt io5.</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	</main>
	<script type="text/javascript" src="../js/jquery.js"></script>
	<script type="text/javascript" src="../js/pagga.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			
			var url = new URL(window.location.href);
			var id = url.searchParams.get("id");
			history.replaceState(null, '', '../html/historico.html');
			var chamado;
			
			busca();
			
			$("#btnAdicionar").click(salvar);
			
			function busca() {
				Pagga.chamado.busca.id(id).done(function(jqXHR) {
					$("#historicoDiv").empty();
					chamado = JSON.parse(jqXHR).chamado;
					console.log(chamado);
					
					$("#nomeSolicitante").val(chamado.usuario.nome);
					$("#selectStatus").val(chamado.status);
					
					chamado.historico.forEach(function(historico) {
						let div = $(document.createElement("div"));
						let h5 = $(document.createElement("h5"));
						let h6 = $(document.createElement("h6"));
						let strong = $(document.createElement("strong"));
						let p = $(document.createElement("p"));
						
						div.addClass("border-bottom");
						
						h5.text(chamado.usuario.nome + " " + historico.dataComentario);
						strong.text(chamado.titulo);
						p.text(historico.comentario);
						
						h6.append(strong);
						div.append(h5);
						div.append(h6);
						div.append(p);
						
						$("#historicoDiv").append(div);
						
						console.log(historico.comentario);
					});
				});
			}
			
			function salvar() {
				let data = {
					historico : {
							comentario : $("#acao").val(),
							usuario : {
								id : chamado.usuario.id
							},
							chamado : {
								id : chamado.id
							}
					},
					file : $("#anexo").val()
				}
				
				Pagga.chamado.historico(data).done(function() {
					busca();
				});
			}
			
		});
	</script>
</body>
</html>