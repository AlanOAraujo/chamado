package br.com.pagga.chamado.service;

import java.util.List;

import javax.inject.Inject;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import br.com.pagga.chamado.dao.PerfilDAO;
import br.com.pagga.chamado.model.Perfil;
import br.com.pagga.chamado.service.exception.BusinessException;

public class PerfilService {
	
	private PerfilDAO perfilDAO;
	
	private PerfilRotinaAtributoService perfilRotinaAtributoService;
	
	private static final Logger logger = LoggerFactory.getLogger(PerfilService.class);

	public PerfilService() {
	}
	
	@Inject
	public PerfilService(PerfilDAO perfilDAO, PerfilRotinaAtributoService perfilRotinaAtributoService) {
		this.perfilDAO = perfilDAO;
		this.perfilRotinaAtributoService = perfilRotinaAtributoService;
	}
	
	public List<Perfil> buscarPerfil() {

		List<Perfil> list = perfilDAO.findAll();
		
		return list;
	
	}
	
	public void cadastrarPerfil(Perfil perfil) {
		
		if ( StringUtils.isBlank(perfil.getDescricao()))
			throw new BusinessException("Descrição do Perfil é obrigatória");
		
		Perfil findByDescricao = perfilDAO.findByDescricao(perfil.getDescricao());
		
		if(findByDescricao != null) {
			throw new BusinessException(String.format("Perfil %s já cadastrado", perfil.getDescricao()));
		}
		
		if(perfil != null && perfil.getId() != null)
			logger.info("Perfil {} atualizado com sucesso!", perfil.getDescricao());
		else
			logger.info("Perfil {} cadastrado com sucesso!", perfil.getDescricao());
		
		perfilDAO.save(perfil);
	}

	public void removePerfil(Perfil perfil) {
				
		Perfil perfilRemove = perfilDAO.findById(perfil.getId());
		
		if ( perfilRemove == null )
			throw new IllegalArgumentException("perfil is null");
		
		if(perfilRemove.getUsuarioPerfilList().size() > 0) 
			throw new IllegalArgumentException("A Usuarios utilizando este perfil.");		
			
			/*for (int i = 0; i < perfil.getUsuarioPerfilList().size(); i++) {
				perfil.getUsuarioPerfilList().get(i).getUsuario();
			}
		*/
		if(perfilRemove.getPerfilRotinaAtributo().size() > 0) {
			perfilRotinaAtributoService.removerTodasAsRotinasDoPerfil(perfilRemove);
			perfilDAO.remove(perfilRemove);
		}
			
		perfilDAO.remove(perfilRemove);
	}
	
}
