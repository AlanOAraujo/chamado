<!DOCTYPE html>

<html lang="pt-br">
	<head>
		<meta charset="UTF-8">
		<title>Chamado</title>
		<link rel="stylesheet" href="../css/bootstrap.min.css">
		<link rel="stylesheet" href="../css/jquery.dataTables.min.css">
		<link rel="stylesheet" href="../css/pagga.css?version=12">
		<link rel="stylesheet" href="../css/pagga.roles.css?version=12">
	</head>
	<body>
		<div id="row-chamados">
			<div class="col-navegation">
				<header class="header-navigation">
					<nav class="navbar navbar-light navbar-telas" role="navigation">
						<div class="div-imgPagga">
							<img src="../images/paggacopyright.png" alt="Logo marca da Pagga" class="img-responsive imgPagga" role="img">
						</div>	
						
						<div class="navbar-collapse collapse" id="sidebar-navbar-collapse-1">
							<div class="div-usuarioLogado">
								<h5 id="usuarioLogado" ><a class="infoUserLogado" href="../html/informacoes-usuario.html" ></a></h5>
							</div>
							<ul class="navbar-nav">								
								<li class="nav-item active ACS_IND">
									<a class="nav-link" href="../html/chamado.html" >
										Indicadores
									</a>
								</li>
								<li class="nav-item OPN_TCK">
									<a class="nav-link" href="../html/chamado-novo.html" >Abrir Ticket</a>
								</li>
								<li class="nav-item CAD_USR">
									<a class="nav-link" href="../html/usuario.html">Usuários</a>
								</li>
								
								<li class="nav-item CAD_PRF">
									<a class="nav-link" href="../html/perfil.html">Perfil de acesso</a>
								</li>
								
								<li class="nav-item">
									<a class="nav-link desloga">Sair</a>
								</li>
								
							</ul>
						</div>
					</nav>
		        </header>
			</div>
			<div class="col-formulario ACS_IND">
				<form id="formChamados">
				
					<section>			
						<div class="container">
							<div class="row">
							
								<div class="col-sm-6">
								
									<h1>Indicadores</h1>
								
								</div>
							
								<div class="col-sm SCH_ALL_TCK">
									<div id="div-search-chm" class="input-group mb-3 input-search-chm">
										<input id="input-search-ticket" type="text" class="form-control" aria-describedby="btn-ticket-search" data-toggle="tooltip">
										
										<div class="input-group-append">
											<button class="btn btn-outline-secondary" type="button" id="btn-ticket-search">Ticket</button>
										</div>
									</div>
								</div>
							</div>
						</div>	
					</section>
					
					<section class="chm-tabelas">
					
						<div class="container">
							<div class="row">
								<div id="div-chmtb-aberto" class="table-responsive col-sm">
									<label for="chmtb-aberto"><strong>Resumo de Tickets abertos</strong></label>
									
									<table id="chmtb-aberto" class="table table-striped table-sm table-bordered text-center">
										
										<thead>
											<tr>
												<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Código</th>
												<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Usuário</th>
												<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Tipo</th>
												<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Data</th>
												<th class="chmtb-aberto-th" aria-controls="chmtb-aberto">Status</th>
											</tr>
										</thead>
									
									</table>
								
								</div>
								
								<div id="div-chmtb-andamento" class="table-responsive col-sm">
									<label for="chmtb-andamento"><strong>Resumo de Tickets em atendimento</strong></label>
									
									<table id="chmtb-andamento" class="table table-striped table-sm table-bordered text-center">
										
										<thead>
											<tr>
												<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Código</th>
												<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Usuário</th>
												<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Tipo</th>
												<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Previsão</th>
												<th class="chmtb-andamento-th" aria-controls="chmtb-andamento">Status</th>
											</tr>
										</thead>
									</table>
						
								</div>
								
							</div>
						</div>
						
						
						<div class="container">
							<div class="row">
								
								<div id="div-chmtb-historico" class="table-responsive col-sm">
									<label for="chmtb-historico"><strong>Histórico de tickets</strong></label>
									
									<table id="chmtb-historico" class="table table-striped table-sm table-bordered text-center">
										
										<thead>
											<tr>
												<th class="chmtb-historico-th" aria-controls="chmtb-historico">Cód.Ticket</th>
												<th class="chmtb-historico-th" aria-controls="chmtb-historico">Usuário</th>
												<th class="chmtb-historico-th" aria-controls="chmtb-historico">Título</th>
												<th class="chmtb-historico-th" aria-controls="chmtb-historico">Data</th>
												<th class="chmtb-historico-th" aria-controls="chmtb-historico">Status</th>
											</tr>
										</thead>
									
									</table>
						
								</div>
							
								<div id="div-chmtb-finalizado" class="table-responsive col-sm">
									<label for="chmtb-finalizado"><strong>Resumo de Tickets fechado</strong></label>
									
									<table id="chmtb-finalizado" class="table table-striped table-sm table-bordered text-center">
										
										<thead>
											<tr>
												<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Código</th>
												<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Tipo</th>
												<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Por</th>
												<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Finalizado</th>
												<th class="chmtb-finalizado-th" aria-controls="chmtb-finalizado">Status</th>
											</tr>
										</thead>
									
									</table>
						
								</div>
								
							</div>
						</div>
					</section>
				
				</form>
			</div>	
		</div>
		<script type="text/javascript" src="../js/jquery.js"></script>
		<script type="text/javascript" src="../js/pagga.js"></script>
		<script type="text/javascript" src="../js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" src="../js/Popper.js"></script>
		<script type="text/javascript" src="../js/popper.min.js"></script>
		<script type="text/javascript" src="../js/bootstrap.min.js"></script>
		
		<script type="text/javascript">
			$(document).ready(function() {
				
				Pagga.login.verificaLogin().done(function(jqXHR) {
					
					usuarioLogado(jqXHR.usuario.nome);
					
					Pagga.login.usuarioRole().done(function(jqXHRole) {
						let roles = jqXHRole.role.roles;
						
						const bjt_role = [];
						
						for (let i = 0; i < roles.length; i++) {
							const role = roles[i];
							bjt_role.push(role.codAtributo);
						}
						
						bjt_role.forEach(function(e){
							verificarRoles(e);
						});
						
					});
					
				}).fail( function(erro){
					window.location.href = '../html/login.html';
				});
				
				$('#formChamados').on("keypress", function(e) {
					if ((e.keyCode == 10)||(e.keyCode == 13)) {
				    	e.preventDefault();
			        }
			    });
				
				$('#input-search-ticket').tooltip({
					 title : 'A pesquisa funciona apenas nas tabelas resumo. </br> Para pesquisar os tickets informe apenas uma das seguintes informações:</br></br> - <i>Código do ticket</i></br></br> - <i>Nome do usuário</i></br></br> - <i>Tipo: Para pesquisar sobre o tipo, é necessário informar o nome exato do tipo. </br>° Incidente </br> ° Solicitação </br> ° Relatório </br> ° Dúvida</i></br></br> - <i>Data: Para pesquisar pela data é necessario colocar a barra informando Dia/Mês/Ano Ex: 01/01/2019</i></br>',
					 placement : 'bottom',
					 trigger: 'hover',
					 html : true
				});
				
				var filtro;
				
				$.fn.dataTable.ext.errMode = 'none';
				
				var tabelaAberto = $('#chmtb-aberto').DataTable({
					"searching": false,
					"lengthChange": false,
					"responsive": true,
					"processing": true,
			        "serverSide": true,
			        "pageLength": 4,
			        "info": true,
			        "pagingType": 'full',
			        "language": {
			        	"zeroRecords": "Pesquisa não encontrada com status aberto",
			        	"emptyTable": "Não há tickets em aberto",
			        	"info": "Mostrando _START_ de _END_ com _TOTAL_ total",
			            "paginate": {
			            	"first": "Primeiro",
			            	"last": "Último",
			                "previous": '‹',
			                "next":     '›'
			            }
			        },
			        "ajax": {
			        	"url" : '../chamado/paginacao',
			        	"datatype": "json",
			        	"data": function ( d ) {
			        	     return $.extend( {}, d, {
			        	       "status": "ABERTO",
			        	       "filtro": filtro
			        	     } );
			        	   }
			        },
			        "columnDefs": [
			            { 
			            	"targets": [0],
			            	"orderable": false,
			            	"data": function(data){
			                    return '<a href="../html/historico.html?id='+data.id+'">'+data.id+'</a>';
			            	}    
						},
						{ 
			            	"targets": [1],
			            	"orderable": false,
			            	"data": function(data){
			            		return data.usuario.nome;
			                }
						},
						{ 
			            	"targets": [2],
			            	"orderable": false,
			            	"data": "tipo" 
						},
						{ 
			            	"targets": [3],
			            	"orderable": false,
			            	"data": "data" 
						},
						{ 
			            	"targets": [4],
			            	"orderable": false,
			            	"data": "status" 
						}
			          ]
				});
				
				var tabelaAtendimento = $('#chmtb-andamento').DataTable({
					"searching": false,
					"lengthChange": false,
					"responsive": true,
					"processing": true,
			        "serverSide": true,
			        "pageLength": 4,
			        "info": true,
			        "pagingType": 'full',
			        "language": {
			        	"zeroRecords": "Pesquisa não encontrada com status em atendimento",
			        	"emptyTable": "Não há tickets em atendimento",
			        	"info": "Mostrando _START_ de _END_ com _TOTAL_ total",
			            "paginate": {
			            	"first": "Primeiro",
			            	"last": "Último",
			                "previous": '‹',
			                "next":     '›'
			            }
			        },
			        "ajax": {
			        	"url" : '../chamado/paginacao',
			        	"datatype": "json",
			        	"data": function ( d ) {
			        	     return $.extend( {}, d, {
			        	       "status": "EM_ATENDIMENTO",
			        	       "filtro": filtro
			        	     } );
			        	   }
			        },
			        "columnDefs": [
			            { 
			            	"targets": [0],
			            	"orderable": false,
			            	"data": function(data){
			                    return '<a href="../html/historico.html?id='+data.id+'">'+data.id+'</a>';
			            	}    
						},
						{ 
			            	"targets": [1],
			            	"orderable": false,
			            	"data": function(data){
			            		return data.usuario.nome;
			                }
						},
						{ 
			            	"targets": [2],
			            	"orderable": false,
			            	"data": "tipo" 
						},
						{ 
			            	"targets": [3],
			            	"orderable": false,
			            	"data": "dataPrevisao" 
						},
						{ 
			            	"targets": [4],
			            	"orderable": false,
			            	"data": "status" 
						}
			          ]
				});
				
				var tabelaFinalizado = $('#chmtb-finalizado').DataTable({
					"searching": false,
					"lengthChange": false,
					"responsive": true,
					"processing": true,
			        "serverSide": true,
			        "pageLength": 4,
			        "info": true,
			        "pagingType": 'full',
			        "language": {
			        	"zeroRecords": "Pesquisa não encontrada com status fechado",
			        	"emptyTable": "Não há tickets fechados",
			        	"info": "Mostrando _START_ de _END_ com _TOTAL_ total",
			            "paginate": {
			            	"first": "Primeiro",
			            	"last": "Último",
			                "previous": '‹',
			                "next":     '›'
			            }
			        },
			        "ajax": {
			        	"url" : '../chamado/paginacao',
			        	"datatype": "json",
			        	"data": function ( d ) {
			        	     return $.extend( {}, d, {
			        	    	 "status": "FECHADO",
			        	    	 "filtro": filtro
			        	     } );
			        	   }
			        },
			        "columnDefs": [
			            { 
			            	"targets": [0],
			            	"orderable": false,
			            	"data": function(data){
			                    return '<a href="../html/historico.html?id='+data.id+'">'+data.id+'</a>';
			            	}    
						},
						{ 
			            	"targets": [1],
			            	"orderable": false,
			            	"data": "tipo"
						},
						{ 
			            	"targets": [2],
			            	"orderable": false,
			            	"data": function(data){
			            		return data.usuarioFechamento.nome;
			                }
						},
						{ 
			            	"targets": [3],
			            	"orderable": false,
			            	"data": "dataFechamento" 
						},
						{ 
			            	"targets": [4],
			            	"orderable": false,
			            	"data": "status" 
						}
			          ]
				});
				
				var tabelaHistorico = $('#chmtb-historico').DataTable({
					"searching": false,
					"lengthChange": false,
					"responsive": true,
					"processing": true,
			        "serverSide": true,
			        "pageLength": 4,
			        "info": true,
			        "pagingType": 'full',
			        "language": {
			        	"emptyTable": "Não há histórico de tickets",
			        	"info": "Mostrando _START_ de _END_ com _TOTAL_ total",
			            "paginate": {
			            	"first": "Primeiro",
			            	"last": "Último",
			                "previous": '‹',
			                "next":     '›'
			            }
			        },
			        "ajax": {
			        	"url" : '../chamado/paginacao/historico',
			        	"datatype": "json",
			        },
			        "columnDefs": [
			            { 
			            	"targets": [0],
			            	"orderable": false,
			            	"data": function(data){
			                    return '<a href="../html/historico.html?id='+data.chamadoid+'">'+data.chamadoid+'</a>';
			            	}    
						},
						{ 
			            	"targets": [1],
			            	"orderable": false,
			            	"data": function(data){
			                    var json = data.usuario;
			                    return json; 
			                }
						},
						{ 
			            	"targets": [2],
			            	"orderable": false,
			            	"data": function(data){
			                    var json = data.titulo;
			                    return  json.length > 9 ? json.substr( 0, 9 ) + '…' : json;
			                }
						},
						{ 
			            	"targets": [3],
			            	"orderable": false,
			            	"data": "datacomentario" 
						},
						{ 
			            	"targets": [4],
			            	"orderable": false,
			            	"data": "status" 
						}
			          ]
				});
				
			    $('#btn-ticket-search').on('click', function(event){
					event.preventDefault();
					
					filtro = $('#input-search-ticket').val();
					tabelaAberto.ajax.reload(); 
					tabelaAtendimento.ajax.reload();
					tabelaFinalizado.ajax.reload();
				});
			    
			    $('.desloga').on('click', function(event){
					event.preventDefault();
					
					Pagga.login.desloga().done(function(jqXHR) {
						window.location.href = '../html/login.html';
					});

				});
			    
				function verificarRoles(e){
					
					Pagga.atributo.lista().done(function(jqXHRAtributo){
						if(jqXHRAtributo. atributos.some(atributo => atributo.codAtributo === e)){
							if(e == "CAD_USR"){
								$(".CAD_USR").css({"display":"block"});
							}else if(e == "CAD_PRF"){
								$(".CAD_PRF").css({"display":"block"});
							}else if(e == "ACS_IND"){
								$(".ACS_IND").css({"display":"block"});
								$("#chmtb-aberto").css({"width":"100%"});
								$("#chmtb-andamento").css({"width":"100%"});
								$("#chmtb-historico").css({"width":"100%"});
								$("#chmtb-finalizado").css({"width":"100%"});
							}else if(e == "OPN_TCK"){
								$(".OPN_TCK").css({"display":"block"})
							}else if(e == "SCH_ALL_TCK"){
								$(".SCH_ALL_TCK").css({"display":"flex"})
							}
						}else{
							console.log("Não tem permissão")
							/* $('#btn-novoUsuario').css({"display":"none"}); */
						}
					});
				}
			    
			});
			
			function exibeMensagem(msg, sucesso){
				if(sucesso) {
					mostraDialogo('#message', 3000);
					$('#message').text(msg);
					$('#message').removeClass('hide');
					$('#message').addClass('alert');
					$('#message').addClass('alert-success');
					$('#message').addClass('alert-dismissible');
				} else {
					mostraDialogo('#message', 3000);
					$('#message').text(msg);
					$('#message').removeClass('hide');
					$('#message').addClass('alert');
					$('#message').addClass('alert-danger');
					$('#message').addClass('alert-dismissible');
				}
			}
			
			function mostraDialogo(mensagem, tempo){
				
			    $('#message').stop().fadeTo(1, 1).removeClass('hidden');
			    
			    setTimeout(function() {
			        $('#message').fadeTo(300, 0).slideUp(300, function(){
			        	$('#message').text('').addClass('hidden');
			        });
			    }, tempo);
	
			}
			
			function usuarioLogado(nome) {
				$(".infoUserLogado").text(nome);
			}
			
		</script>
	
	</body>
</html>